<!DOCTYPE html>
<html>
<head>
    <title>VibeTurn Web Player (Ejemplo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos básicos para demostración */
        body { font-family: sans-serif; padding: 10px; }
        #player-container {
            position: relative;
            width: 100%;
            max-width: 640px; /* O el tamaño que prefieras */
            aspect-ratio: 16 / 9; /* Mantiene la proporción del video */
            margin-bottom: 10px;
            background-color: #000;
        }
        #html5-player { /* Changed from #youtube-player */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #controls button { padding: 8px 12px; margin: 5px; }
        #info { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
        #info p { margin: 5px 0; }
    </style>
</head>
<body>

    <h1>VibeTurn - Reproductor Web</h1>

    <div id="player-container">
        <!-- Replaced div with video tag -->
        <video id="html5-player" playsinline controls></video>
    </div>

    <div id="controls">
        <button onclick="playPreviousTrack()">Anterior</button>
        <button onclick="togglePlayPause()">Play/Pause (Web)</button>
        <button onclick="playNextTrack()">Siguiente</button>
        <button onclick="stopPlaybackAndNotify()">Detener (DEBUG)</button>
    </div>

    <div id="info">
        <h2>Información Actualon:</h2>
        <p>Estado: <span id="status">Esperando...</span></p>
        <p>Video ID: <span id="videoId">N/A</span></p>
        <p>Título: <span id="title">N/A</span></p>
        <p>Artista: <span id="artist">N/A</span></p>
    </div>

    <script>
        // --- Configuración ---
        // ¡¡REEMPLAZA ESTO CON TU LÓGICA REAL DE PLAYLIST!!
        const playlistVideoIds = [
            'https://rr2---sn-apaapm4g-apae.googlevideo.com/videoplayback?expire=1746950739&ei=8wUgaNyuCfGJvdIP5qW40Qo&ip=2a00%3Ab6e0%3A1%3A20%3A15%3A%3A1&id=o-AHMfXJiGtrrGvW7VyrnJwmR49ZJZ2Yqtjd-nSMpCQcb9&itag=18&source=youtube&requiressl=yes&xpc=EgVo2aDSNQ%3D%3D&met=1746929139%2C&mh=7c&mm=31%2C29&mn=sn-apaapm4g-apae%2Csn-25ge7nz6&ms=au%2Crdu&mv=u&mvi=2&pcm2cms=yes&pl=48&rms=au%2Cau&bui=AecWEAb79jUcOD6bYwTofrXN3kxK93qvF1lGfab-KnVSaxr0YN8jvv3SJyMl2PVfxteuu66paOJCj6e_&vprv=1&svpuc=1&mime=video%2Fmp4&ns=eO_erks-iitrcZb36b5_p04Q&rqh=1&cnr=14&ratebypass=yes&dur=212.091&lmt=1717051812678016&mt=1746928862&fvip=1&lmw=1&fexp=51466697&c=TVHTML5&sefc=1&txp=4538434&n=kloPquSNmQlmMQ&sparams=expire%2Cei%2Cip%2Cid%2Citag%2Csource%2Crequiressl%2Cxpc%2Cbui%2Cvprv%2Csvpuc%2Cmime%2Cns%2Crqh%2Ccnr%2Cratebypass%2Cdur%2Clmt&lsparams=met%2Cmh%2Cmm%2Cmn%2Cms%2Cmv%2Cmvi%2Cpcm2cms%2Cpl%2Crms&lsig=ACuhMU0wRQIgV4mVbnSovnic3QB8re49ud41zWh-ck3HWDAGG86B9nUCIQDCpyu_GMvSHJxqQ0q9D3tJng9rfM_qYpExPJukH8L1fQ%3D%3D&sig=AJfQdSswRQIgBw8rqVNJulj6wvSrmaWRF-WzLOHOgk9i1QKh8avr04UCIQC__3Ss2oJPscnggbw9QvuV6ajMxQcd1-HswiI4iJehJA%3D%3D', // Rick Astley - Never Gonna Give You Up
            'https://rr2---sn-apaapm4g-apae.googlevideo.com/videoplayback?expire=1746950817&ei=QQYgaKjdG67VxN8PqNaeoQk&ip=2a00%3Ab6e0%3A1%3A20%3A15%3A%3A1&id=o-AE0lN2H97BCLMsNGPVqLDKFMNbawhTHJyPa7TD6RVsgu&itag=18&source=youtube&requiressl=yes&xpc=EgVo2aDSNQ%3D%3D&met=1746929217%2C&mh=Vq&mm=31%2C29&mn=sn-apaapm4g-apae%2Csn-25glenlk&ms=au%2Crdu&mv=u&mvi=2&pl=48&rms=au%2Cau&bui=AecWEAYhnF1gDfBvvvCJXzc93M0hqpNfXrc-rfhMEgcyznnlZzbQOVkxd6vgsIPpOYuyqCQ1izdx-8H6&vprv=1&svpuc=1&mime=video%2Fmp4&ns=UjZWJUhK0WqnfDok_KLRzDwQ&rqh=1&cnr=14&ratebypass=yes&dur=185.852&lmt=1738656102464016&mt=1746928862&fvip=5&lmw=1&c=TVHTML5&sefc=1&txp=4438534&n=Z6s4Dv6ZzL2hCw&sparams=expire%2Cei%2Cip%2Cid%2Citag%2Csource%2Crequiressl%2Cxpc%2Cbui%2Cvprv%2Csvpuc%2Cmime%2Cns%2Crqh%2Ccnr%2Cratebypass%2Cdur%2Clmt&sig=AJfQdSswRQIhALaQdj4kBz--Tds7Mrq492OVch9i_SbOr9OpvZv_J6pzAiBZ8sdCAFRy3M1A2RjXQLqNlq03-aks38cV6nHQVqGkow%3D%3D&lsparams=met%2Cmh%2Cmm%2Cmn%2Cms%2Cmv%2Cmvi%2Cpl%2Crms&lsig=ACuhMU0wRQIhAPL6ukxMADMe8RyKM2IA2irfrZ3KN5fcE3kOCIj7KpyWAiA4WyM0k9RavVlKCW3bp9jHhmPv95Af2BaZuqQkqRhSRg%3D%3D', // me at the zoo (ejemplo corto)

        ];
        let currentPlaylistIndex = 0;
        const initialVideoId = playlistVideoIds[currentPlaylistIndex];

        // --- Variables Globales ---
        var player; // Variable global para el objeto <video>
        var currentVideoInfo = { id: null, title: null, artist: null, artwork: null };
        // var lastState = -1; // No longer needed with direct event handling

        // --- Inicialización del Reproductor HTML5 ---
        function initializeHtml5Player() {
            console.log("initializeHtml5Player: Inicializando reproductor HTML5.");
            player = document.getElementById('html5-player');

            if (!player) {
                console.error("Error: No se encontró el elemento de video #html5-player.");
                return;
            }

            // Event listeners para el reproductor HTML5
            player.addEventListener('loadeddata', onPlayerReady); // Equivalente a onReady para el video inicial
            player.addEventListener('play', onPlay);
            player.addEventListener('pause', onPause);
            player.addEventListener('ended', onEnded);
            player.addEventListener('error', onPlayerError);
            // player.addEventListener('waiting', onBuffering); // Opcional para estado de carga

            // Cargar el video inicial
            player.src = initialVideoId;
            player.load(); // Asegura que el navegador cargue la nueva fuente
            // Autoplay podría ser manejado aquí o por el atributo 'autoplay' en <video>
            // player.play(); // Opcional: intentar autoplay (puede ser bloqueado)
            updateDisplayInfo("Cargando video inicial...");
        }

        // Se llama cuando los metadatos del video se han cargado (para el video inicial)
        function onPlayerReady() {
            console.log("onPlayerReady: Reproductor listo con video:", player.currentSrc);
            // El ID aquí es la URL completa del video.
            updateDisplayInfo("Listo (Video: " + 간단하게URL축약(player.currentSrc) + ")");
            // Se puede llamar a handlePlayingState si se quiere procesar la info inmediatamente
            // o esperar al evento 'play' si se quiere info solo al reproducir.
            // Si hay autoplay, el evento 'play' se disparará.
        }

        // --- Manejadores de Eventos del Reproductor HTML5 ---
        function onPlay() {
            console.log("Evento: play");
            updateDisplayInfo("Reproduciendo");
            handlePlayingState(); // Lógica para cuando comienza o se reanuda la reproducción
            if (isAndroidApp()) {
                Android.notifyPlaybackResumed();
                console.log("Llamado: Android.notifyPlaybackResumed()");
            }
        }

        function onPause() {
            console.log("Evento: pause");
            updateDisplayInfo("Pausado");
            if (isAndroidApp()) {
                Android.notifyPlaybackPaused();
                console.log("Llamado: Android.notifyPlaybackPaused()");
            }
        }

        function onEnded() {
            console.log("Evento: ended");
            updateDisplayInfo("Finalizado");
            console.log("Intentando reproducir siguiente canción...");
            playNextTrack();
        }

        // function onBuffering() { // Opcional
        //     console.log("Evento: waiting (buffering)");
        //     updateDisplayInfo("Cargando...");
        // }

        function onPlayerError() {
            const error = player.error;
            console.error("onPlayerError: Error del reproductor HTML5:", error);
            let errorMsg = "Error desconocido";
            if (error) {
                switch (error.code) {
                    case MediaError.MEDIA_ERR_ABORTED:
                        errorMsg = "Reproducción abortada por el usuario.";
                        break;
                    case MediaError.MEDIA_ERR_NETWORK:
                        errorMsg = "Error de red al cargar el video.";
                        break;
                    case MediaError.MEDIA_ERR_DECODE:
                        errorMsg = "Error al decodificar el video.";
                        break;
                    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMsg = "Formato de video no soportado o fuente no encontrada.";
                        break;
                    default:
                        errorMsg = `Error desconocido (código: ${error.code})`;
                }
            }
            updateDisplayInfo("Error: " + errorMsg);
            // Podrías intentar saltar a la siguiente canción aquí si es apropiado
            // playNextTrack();
        }


        // --- Lógica de Estado PLAYING ---
        function handlePlayingState() {
            // Asegurarse que el player y currentSrc estén disponibles
            if (!player || !player.currentSrc) {
                console.warn("handlePlayingState: Player o player.currentSrc no disponibles.");
                return;
            }

            const videoId = player.currentSrc; // Usamos la URL completa como ID
            // Para el título y artista, necesitaríamos una estructura de datos más rica
            // o una lógica de extracción más compleja si solo tenemos la URL.
            // Por ahora, usamos la URL o parte de ella.
            const title = 간단하게URL축약(videoId); // Placeholder, extraer de la URL o metadata
            const artist = "Artista Desconocido"; // Placeholder
            const artworkUrl = ""; // Placeholder, no hay artwork directo de <video>
            const currentTime = player.currentTime;

            // Es una canción nueva si el ID cambió O si el tiempo es casi 0 (empezó desde el principio)
            const isNewSong = (videoId !== currentVideoInfo.id) || (currentTime < 1.5);

            if (isNewSong) {
                console.log("handlePlayingState: Detectada nueva canción o inicio.");
                currentVideoInfo = { id: videoId, title: title, artist: artist, artwork: artworkUrl };
                console.log("handlePlayingState: Nueva info:", currentVideoInfo);

                if (isAndroidApp()) {
                    Android.notifySongChanged(videoId, title, artist, artworkUrl);
                    console.log("Llamado: Android.notifySongChanged() con datos nuevos.");
                }
                updateDisplayInfo("Reproduciendo"); // Se actualiza aquí y en onPlay
            } else {
                 console.log("handlePlayingState: Reanudación de la misma canción detectada.");
                 updateDisplayInfo("Reproduciendo");
            }
        }

        // --- Funciones Auxiliares ---

        /** Verifica si la interfaz Android está disponible. */
        function isAndroidApp() {
            const hasInterface = typeof window.Android !== "undefined" && window.Android !== null;
            if (!hasInterface) {
                 // console.log("Interfaz 'Android' no encontrada. Ejecutando en navegador normal?");
            }
            return hasInterface;
        }

        /** Extrae el artista del título (¡IMPLEMENTACIÓN MUY BÁSICA!). */
        // Esta función es menos útil ahora que no tenemos títulos de YouTube.
        // Se puede adaptar si la info viene de otra forma.
        function extractArtistFromTitle(videoUrlOrTitle) {
            if (!videoUrlOrTitle) return "Artista Desconocido";
            // Intenta extraer de un formato "Artista - Título" si se usa
            const parts = videoUrlOrTitle.split('-');
            if (parts.length > 1) {
                return parts[0].trim();
            }
            // Podrías intentar extraer algo del nombre del archivo en la URL
            try {
                const url = new URL(videoUrlOrTitle);
                const pathnameParts = url.pathname.split('/');
                const filename = pathnameParts[pathnameParts.length - 1];
                // Quitar extensión y reemplazar underscores/etc.
                return decodeURIComponent(filename.split('.')[0].replace(/[_-]/g, ' '));
            } catch (e) {
                // No es una URL válida o no se pudo procesar
            }
            return "Artista Desconocido"; // Fallback
        }

        /** Acorta una URL para mostrarla de forma más legible */
        function 간단하게URL축약(url) {
            if (!url) return "N/A";
            try {
                const urlObj = new URL(url);
                const parts = urlObj.pathname.split('/');
                let lastPart = parts[parts.length - 1];
                if (lastPart.length > 30) { // Si es muy largo, tomar una parte
                    lastPart = "..." + lastPart.substring(lastPart.length - 27);
                }
                return lastPart || "video";
            } catch (e) {
                return url.length > 30 ? "..." + url.substring(url.length - 27) : url;
            }
        }


        /** Actualiza la información mostrada en el HTML. */
        function updateDisplayInfo(status) {
            const statusEl = document.getElementById('status');
            const videoIdEl = document.getElementById('videoId');
            const titleEl = document.getElementById('title');
            const artistEl = document.getElementById('artist');

            if (statusEl) statusEl.textContent = status || 'N/A';
            // Para videoId, title, artist, usamos currentVideoInfo que se actualiza en handlePlayingState
            if (videoIdEl) videoIdEl.textContent = 간단하게URL축약(currentVideoInfo.id) || 'N/A';
            if (titleEl) titleEl.textContent = currentVideoInfo.title || 'N/A';
            if (artistEl) artistEl.textContent = currentVideoInfo.artist || 'N/A';
        }

        // --- Funciones llamadas desde Android (o botones de debug) ---

        /** Carga y reproduce la siguiente canción de la playlist. */
        function playNextTrack() {
            console.log("playNextTrack: Intentando reproducir siguiente...");
            currentPlaylistIndex++;
            if (currentPlaylistIndex >= playlistVideoIds.length) {
                currentPlaylistIndex = 0; // Volver al inicio de la lista
                 console.log("playNextTrack: Fin de la lista, volviendo al inicio.");
            }
            const nextVideoSrc = playlistVideoIds[currentPlaylistIndex];
            console.log("playNextTrack: Cargando video:", 간단하게URL축약(nextVideoSrc), "en índice:", currentPlaylistIndex);
            if (player) {
                player.src = nextVideoSrc;
                player.load(); // Es importante llamar a load() después de cambiar src
                player.play().catch(e => console.warn("Autoplay en playNextTrack falló:", e)); // Intentar reproducir
            } else {
                console.error("playNextTrack: El reproductor no está listo o no existe.");
            }
        }

        /** Carga y reproduce la canción anterior de la playlist. */
        function playPreviousTrack() {
             console.log("playPreviousTrack: Intentando reproducir anterior...");
            currentPlaylistIndex--;
            if (currentPlaylistIndex < 0) {
                currentPlaylistIndex = playlistVideoIds.length - 1; // Ir al final de la lista
                 console.log("playPreviousTrack: Inicio de la lista, yendo al final.");
            }
            const prevVideoSrc = playlistVideoIds[currentPlaylistIndex];
             console.log("playPreviousTrack: Cargando video:", 간단하게URL축약(prevVideoSrc), "en índice:", currentPlaylistIndex);
            if (player) {
                player.src = prevVideoSrc;
                player.load();
                player.play().catch(e => console.warn("Autoplay en playPreviousTrack falló:", e));
            } else {
                 console.error("playPreviousTrack: El reproductor no está listo o no existe.");
            }
        }

        /** Alterna entre Play y Pause en el reproductor web. */
        function togglePlayPause() {
            console.log("togglePlayPause: Intentando alternar estado...");
            if (player) {
                 console.log("togglePlayPause: Estado actual del reproductor (paused):", player.paused);
                if (player.paused || player.ended) { // Si está pausado o ha terminado
                     console.log("togglePlayPause: Reproduciendo video...");
                    player.play().catch(e => console.error("Error al intentar reproducir:", e));
                } else {
                     console.log("togglePlayPause: Pausando video...");
                    player.pause();
                }
            } else {
                 console.error("togglePlayPause: El reproductor no está listo o no existe.");
            }
        }

        /** Función de DEBUG para simular una detención completa desde la web. */
        function stopPlaybackAndNotify() {
             console.log("stopPlaybackAndNotify: Deteniendo reproductor y notificando a Android...");
             if (player) {
                player.pause();
                player.currentTime = 0; // Resetea el tiempo del video
                // Opcionalmente, para liberar recursos:
                // player.src = ""; // o player.removeAttribute('src'); player.load();
             }
             if (isAndroidApp()) {
                Android.notifyPlaybackStopped();
                 console.log("Llamado: Android.notifyPlaybackStopped()");
             }
             updateDisplayInfo("Detenido (DEBUG)");
             currentVideoInfo = { id: null, title: null, artist: null, artwork: null }; // Limpiar info
        }

        // Inicializar el reproductor cuando el DOM esté listo
        // Esto reemplaza la necesidad de onYouTubeIframeAPIReady globalmente
        if (document.readyState === 'loading') {  // Carga aún no ha terminado
            document.addEventListener('DOMContentLoaded', initializeHtml5Player);
        } else {  // DOMContentLoaded ya se disparó
            initializeHtml5Player();
        }

    </script>

</body>
</html>