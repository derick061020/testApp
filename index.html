<html><head>
    <title>VibeTurn Web Player (Ejemplo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos básicos para demostración */
        body { font-family: sans-serif; padding: 10px; }
        #player-container {
            position: relative;
            width: 100%;
            max-width: 640px; /* O el tamaño que prefieras */
            aspect-ratio: 16 / 9; /* Mantiene la proporción del video */
            margin-bottom: 10px;
            background-color: #000;
        }
        #youtube-player {
            width: 100%;
            max-height: 360px;
            background-color: #000;
        }
        #controls button { padding: 8px 12px; margin: 5px; }
        #info { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
        #info p { margin: 5px 0; }
    </style>
</head>
<body>

    <h1>VibeTurn - Reproductor Web</h1>

    <div id="player-container">
        <video id="youtube-player" controls style="width: 100%; max-height: 360px; background-color: #000;">
            Tu navegador no soporta el elemento de video.
        </video>
    </div>

    <div id="controls">
        <button onclick="playPreviousTrack()">Anterior</button>
        <button onclick="togglePlayPause()">Play/Pause (Web)</button>
        <button onclick="playNextTrack()">Siguiente</button>
        <button onclick="stopPlaybackAndNotify()">Detener (DEBUG)</button>
        <button onclick="loadYouTubeVideo()">Cargar Video de YouTube</button>
        <input type="text" id="youtube-url" placeholder="Ingrese el enlace de YouTube">
    </div>

    <div id="info">
        <h2>Información Actual:</h2>
        <p>Estado: <span id="status">Pausado</span></p>
        <p>Video ID: <span id="videoId">kJQP7kiw5Fk</span></p>
        <p>Título: <span id="title">Luis Fonsi - Despacito ft. Daddy Yankee</span></p>
        <p>Artista: <span id="artist">Luis Fonsi</span></p>
    </div>

    <script>
        // --- Configuración ---
        // ¡¡REEMPLAZA ESTO CON TU LÓGICA REAL DE PLAYLIST!!
        const playlistVideoIds = [
            'dQw4w9WgXcQ', // Rick Astley - Never Gonna Give You Up
            'jNQXAC9IVRw', // me at the zoo (ejemplo corto)
            'V-Mxk_NqQ2A', // Luis Fonsi - Despacito ft. Daddy Yankee
            'Y6dKNYdVogA',
        ];
        let currentPlaylistIndex = 0;

        // Elemento de video
        const videoPlayerEl = document.getElementById('youtube-player');

        // Variables Globales ---
        var currentVideoInfo = { id: null, title: null, artist: null, artwork: null };

        // --- Funciones Auxiliares ---

        /** Actualiza el display de estado en la página. */
        function updateDisplayInfo(statusText) {
            const statusEl = document.getElementById('status');
            if (statusEl) statusEl.textContent = statusText;

            // Actualizar también la información de la canción si está disponible
            const videoIdEl = document.getElementById('videoId');
            const titleEl = document.getElementById('title');
            const artistEl = document.getElementById('artist');

            if (currentVideoInfo.id && videoIdEl) videoIdEl.textContent = currentVideoInfo.id;
            if (currentVideoInfo.title && titleEl) titleEl.textContent = currentVideoInfo.title;
            if (currentVideoInfo.artist && artistEl) artistEl.textContent = currentVideoInfo.artist;
        }

        /** Intenta extraer el artista del título de una canción. ¡ADAPTA ESTO! */
        function extractArtistFromTitle(title) {
            if (!title) return 'Desconocido';
            const patterns = [
                /(.+?) - .+/,    // "Artista - Título"
                /(.+?) – .+/,    // "Artista – Título" (con en dash)
                /(.+?): .+/,     // "Artista: Título"
                /(.+?) ft\. .+/, // "Artista ft. Otro Artista"
                /(.+?) feat\. .+/,// "Artista feat. Otro Artista"
            ];
            for (const pattern of patterns) {
                const match = title.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            // Si no hay un separador claro, intentar asumir que el título no incluye al artista
            // o devolver una parte del título si es muy largo.
            // Esta es una heurística muy simple.
            const commonSeparators = ['(', '[', '|', '/'];
            let shortestIndex = title.length;
            for (const sep of commonSeparators) {
                const index = title.indexOf(sep);
                if (index !== -1 && index < shortestIndex) {
                    shortestIndex = index;
                }
            }
            if (shortestIndex < title.length && shortestIndex > 3) { // Evitar cortes muy cortos
                return title.substring(0, shortestIndex).trim();
            }

            return 'Artista Desconocido'; // O devolver el título completo si no se puede extraer
        }

        /** Verifica si la app se está ejecutando en el WebView de Android. */
        function isAndroidApp() {
            return typeof Android !== 'undefined' && Android !== null;
        }

        // --- Funciones llamadas desde Android (o botones de debug) ---

        async function loadVideoFromAPI(videoId) {
            console.log(`loadVideoFromAPI: Cargando video ID: ${videoId}`);
            try {
                const response = await fetch(`get_youtube_audio.php?url=https://youtu.be/${videoId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Configurar video
                videoPlayerEl.src = data.video_url; // Usar video_url
                videoPlayerEl.poster = data.thumbnail_url;
                
                const playPromise = videoPlayerEl.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Error al intentar reproducir automáticamente:", error);
                        // Podrías necesitar interacción del usuario para iniciar la reproducción
                        updateDisplayInfo("Error al reproducir. Toca play.");
                    });
                }


                // Actualizar información
                const title = data.title || 'Título Desconocido';
                const artist = extractArtistFromTitle(title);
                const artwork = data.thumbnail_url;

                currentVideoInfo = {
                    id: videoId,
                    title: title,
                    artist: artist,
                    artwork: artwork
                };
                updateDisplayInfo("Cargando..."); // Se actualizará a "Reproduciendo" con el evento 'play'

                // Actualizar display HTML
                document.getElementById('videoId').textContent = videoId;
                document.getElementById('title').textContent = title;
                document.getElementById('artist').textContent = artist;

                console.log('Video URL:', data.video_url);
                console.log('Thumbnail URL:', data.thumbnail_url);

                // Notificar a Android sobre el cambio de canción
                if (isAndroidApp()) {
                    Android.notifySongChanged(videoId, title, artist, artwork);
                    console.log("Llamado: Android.notifySongChanged() con datos nuevos.");
                }

            } catch (error) {
                console.error('Error en loadVideoFromAPI:', error);
                updateDisplayInfo('Error al cargar video.');
                alert('No se pudo cargar el video. Verifica el enlace o la respuesta del servidor.');
                 if (isAndroidApp()) {
                    Android.notifyPlaybackError("Error al cargar video: " + error.message);
                 }
            }
        }

        // Función para reproducir siguiente track
        function playNextTrack() {
            console.log("playNextTrack: Intentando reproducir siguiente...");
            currentPlaylistIndex++;
            if (currentPlaylistIndex >= playlistVideoIds.length) {
                currentPlaylistIndex = 0;
                 console.log("playNextTrack: Fin de la lista, volviendo al inicio.");
            }
            const nextVideoId = playlistVideoIds[currentPlaylistIndex];
            console.log("playNextTrack: Cargando video ID:", nextVideoId, "en índice:", currentPlaylistIndex);
            loadVideoFromAPI(nextVideoId);
        }

        // Función para reproducir track anterior
        function playPreviousTrack() {
             console.log("playPreviousTrack: Intentando reproducir anterior...");
            currentPlaylistIndex--;
            if (currentPlaylistIndex < 0) {
                currentPlaylistIndex = playlistVideoIds.length - 1;
                 console.log("playPreviousTrack: Inicio de la lista, yendo al final.");
            }
            const prevVideoId = playlistVideoIds[currentPlaylistIndex];
             console.log("playPreviousTrack: Cargando video ID:", prevVideoId, "en índice:", currentPlaylistIndex);
            loadVideoFromAPI(prevVideoId);
        }

        // Función para alternar play/pause
        function togglePlayPause() {
            console.log("togglePlayPause: Intentando alternar estado...");
            if (!videoPlayerEl) {
                console.error("togglePlayPause: El elemento de video no existe.");
                return;
            }
            if (videoPlayerEl.paused || videoPlayerEl.ended) {
                console.log("togglePlayPause: Reproduciendo video...");
                const playPromise = videoPlayerEl.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Error al llamar a play() en togglePlayPause:", error);
                        updateDisplayInfo("Error al reproducir.");
                    });
                }
            } else {
                console.log("togglePlayPause: Pausando video...");
                videoPlayerEl.pause();
            }
        }


        // Cargar el primer video al inicio
        if (playlistVideoIds.length > 0) {
            loadVideoFromAPI(playlistVideoIds[currentPlaylistIndex]);
        } else {
            console.warn("Playlist está vacía. No se cargará ningún video inicial.");
            updateDisplayInfo("Playlist vacía.");
        }

        // Eventos para controlar reproducción y notificar a Android
        if (videoPlayerEl) {
            videoPlayerEl.addEventListener('ended', () => {
                console.log("Evento: ended - Reproducción finalizada, intentando siguiente track.");
                updateDisplayInfo("Finalizado");
                // NO llamar a notifyPlaybackStopped() aquí si vamos a la siguiente
                playNextTrack();
            });

            videoPlayerEl.addEventListener('play', () => {
                console.log("Evento: play - La reproducción ha comenzado o se ha reanudado.");
                updateDisplayInfo("Reproduciendo");
                if (isAndroidApp()) {
                    Android.notifyPlaybackResumed();
                    console.log("Llamado: Android.notifyPlaybackResumed()");
                }
            });

            videoPlayerEl.addEventListener('pause', () => {
                // Solo notificar pausa si no es porque el video terminó (el evento 'ended' se encarga de eso)
                // y si no es porque estamos a punto de cargar otra cancion (evitar doble notificacion)
                if (!videoPlayerEl.ended) {
                    console.log("Evento: pause - La reproducción se ha pausado.");
                    updateDisplayInfo("Pausado");
                    if (isAndroidApp()) {
                        Android.notifyPlaybackPaused();
                        console.log("Llamado: Android.notifyPlaybackPaused()");
                    }
                }
            });

            videoPlayerEl.addEventListener('error', (e) => {
                console.error("Evento: error - Error en el elemento de video:", videoPlayerEl.error);
                let errorMsg = "Error desconocido en el reproductor.";
                if (videoPlayerEl.error) {
                    switch (videoPlayerEl.error.code) {
                        case MediaError.MEDIA_ERR_ABORTED:
                            errorMsg = 'Reproducción abortada por el usuario.';
                            break;
                        case MediaError.MEDIA_ERR_NETWORK:
                            errorMsg = 'Error de red al cargar el video.';
                            break;
                        case MediaError.MEDIA_ERR_DECODE:
                            errorMsg = 'Error al decodificar el video.';
                            break;
                        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMsg = 'Formato de video no soportado.';
                            break;
                        default:
                            errorMsg = `Error desconocido (código ${videoPlayerEl.error.code}).`;
                    }
                }
                updateDisplayInfo(errorMsg);
                if (isAndroidApp()) {
                    Android.notifyPlaybackError(errorMsg);
                }
                // Opcional: intentar saltar al siguiente track en caso de error
                // playNextTrack();
            });

            // Evento cuando se ha cargado suficiente data para empezar a reproducir
            videoPlayerEl.addEventListener('canplay', () => {
                console.log("Evento: canplay - El navegador puede empezar a reproducir el video.");
                 // No es necesario hacer nada aquí usualmente si autoplay está activado o se llama a play()
            });
            
            // Evento cuando se actualiza el tiempo de reproducción
            videoPlayerEl.addEventListener('timeupdate', () => {
                // Aquí podrías actualizar una barra de progreso si la tuvieras
                // console.log("Time update:", videoPlayerEl.currentTime);
                if (isAndroidApp() && typeof Android.notifyPlaybackPosition === 'function') {
                    Android.notifyPlaybackPosition(videoPlayerEl.currentTime, videoPlayerEl.duration);
                }
            });

        } else {
            console.error("El elemento de video 'youtube-player' no se encontró en el DOM.");
        }


        // Función de DEBUG para simular una detención completa desde la web.
        function stopPlaybackAndNotify() {
             console.log("stopPlaybackAndNotify: Deteniendo reproductor y notificando a Android...");
             if (videoPlayerEl) {
                videoPlayerEl.pause(); // Detiene el video actual
                videoPlayerEl.currentTime = 0; // Opcional: resetear tiempo
             }
             if (isAndroidApp()) {
                Android.notifyPlaybackStopped();
                console.log("Llamado: Android.notifyPlaybackStopped()");
             }
             updateDisplayInfo("Detenido (Debug)");
        }

        // Función para extraer el ID de un video de YouTube desde una URL
        function extractYouTubeVideoId(url) {
            // Expresiones regulares para diferentes formatos de URL de YouTube
            const patterns = [
                /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/ // También acepta solo el ID
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return match[1];
                }
            }
            return null;
        }
    </script>
</body>
</html>