<html><head>
    <title>VibeTurn Web Player (Ejemplo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Estilos básicos para demostración */
        body { font-family: sans-serif; padding: 10px; }
        #player-container {
            position: relative;
            width: 100%;
            max-width: 640px; /* O el tamaño que prefieras */
            aspect-ratio: 16 / 9; /* Mantiene la proporción del video */
            margin-bottom: 10px;
            background-color: #000;
        }
        #youtube-player {
            width: 100%;
            max-height: 360px;
            background-color: #000;
        }
        #controls button { padding: 8px 12px; margin: 5px; }
        #info { margin-top: 15px; border: 1px solid #ccc; padding: 10px; }
        #info p { margin: 5px 0; }
    </style>
</head>
<body>

    <h1>VibeTurn - Reproductor Web</h1>

    <div id="player-container">
        <video id="youtube-player" controls style="width: 100%; max-height: 360px; background-color: #000;">
            Tu navegador no soporta el elemento de video.
        </video>
    </div>

    <div id="controls">
        <button onclick="playPreviousTrack()">Anterior</button>
        <button onclick="togglePlayPause()">Play/Pause (Web)</button>
        <button onclick="playNextTrack()">Siguiente</button>
        <button onclick="stopPlaybackAndNotify()">Detener (DEBUG)</button>
        <button onclick="loadYouTubeVideo()">Cargar Video de YouTube</button>
        <input type="text" id="youtube-url" placeholder="Ingrese el enlace de YouTube">
    </div>

    <div id="info">
        <h2>Información Actual:</h2>
        <p>Estado: <span id="status">Pausado</span></p>
        <p>Video ID: <span id="videoId">kJQP7kiw5Fk</span></p>
        <p>Título: <span id="title">Luis Fonsi - Despacito ft. Daddy Yankee</span></p>
        <p>Artista: <span id="artist">Luis Fonsi</span></p>
    </div>

    <script>
        // --- Configuración ---
        // ¡¡REEMPLAZA ESTO CON TU LÓGICA REAL DE PLAYLIST!!
        const playlistVideoIds = [
            'dQw4w9WgXcQ', // Rick Astley - Never Gonna Give You Up
            'jNQXAC9IVRw', // me at the zoo (ejemplo corto)
            'V-Mxk_NqQ2A', // Luis Fonsi - Despacito ft. Daddy Yankee
            'kJQP7kiw5Fk'  // Ed Sheeran - Shape of You
        ];
        let currentPlaylistIndex = 0;

        // Elemento de video
        const videoPlayerEl = document.getElementById('youtube-player');

        // Variables Globales ---
        var currentVideoInfo = { id: null, title: null, artist: null, artwork: null };

        // --- Funciones Auxiliares ---

        /** Verifica si la interfaz Android está disponible. */
        function isAndroidApp() {
            // `window.Android` es el nombre que le dimos en `addJavascriptInterface`
            const hasInterface = typeof window.Android !== "undefined" && window.Android !== null;
            if (!hasInterface) {
                 console.log("Interfaz 'Android' no encontrada. Ejecutando en navegador normal?");
            }
            return hasInterface;
        }

        /** Extrae el artista del título (¡IMPLEMENTACIÓN MUY BÁSICA!). */
        function extractArtistFromTitle(title) {
            if (!title) return "Artista Desconocido";
            const parts = title.split('-'); // Asume formato "Artista - Título"
            if (parts.length > 1) {
                return parts[0].trim();
            }
            const partsBy = title.split(' by '); // Asume formato "Título by Artista"
             if (partsBy.length > 1) {
                return partsBy[partsBy.length - 1].trim(); // Toma la última parte
            }
            // Fallback si no encuentra separador común
            // Podrías intentar obtenerlo de videoData si la API lo proporcionara mejor,
            // o idealmente, tenerlo desde tu backend.
            // return videoData.author // Esto no suele funcionar bien para música
            return "Artista Desconocido";
        }

        /** Actualiza la información mostrada en el HTML. */
        function updateDisplayInfo(status) {
            const statusEl = document.getElementById('status');
            const videoIdEl = document.getElementById('videoId');
            const titleEl = document.getElementById('title');
            const artistEl = document.getElementById('artist');

            if (statusEl) statusEl.textContent = status || 'N/A';
            if (videoIdEl) videoIdEl.textContent = currentVideoInfo.id || 'N/A';
            if (titleEl) titleEl.textContent = currentVideoInfo.title || 'N/A';
            if (artistEl) artistEl.textContent = currentVideoInfo.artist || 'N/A';
        }

        // --- Funciones llamadas desde Android (o botones de debug) ---

        /** Carga y reproduce la siguiente canción de la playlist. */
        async function loadVideoFromAPI(videoId) {
            try {
                const response = await fetch(`get_youtube_audio.php?url=https://youtu.be/${videoId}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Configurar video
                videoPlayerEl.src = data.video_url;
                videoPlayerEl.poster = data.thumbnail_url;
                videoPlayerEl.play();

                // Actualizar información
                updateDisplayInfo("Reproduciendo");
                currentVideoInfo = {
                    id: videoId,
                    title: data.title || 'Título Desconocido',
                    artist: extractArtistFromTitle(data.title),
                    artwork: data.thumbnail_url
                };

                // Actualizar display
                document.getElementById('videoId').textContent = videoId;
                document.getElementById('title').textContent = currentVideoInfo.title;
                document.getElementById('artist').textContent = currentVideoInfo.artist;

                console.log('Video URL:', data.video_url);
                console.log('Thumbnail URL:', data.thumbnail_url);

            } catch (error) {
                console.error('Error:', error);
                alert('No se pudo cargar el video. Verifica el enlace.');
            }
        }

        // Función para reproducir siguiente track
        function playNextTrack() {
            currentPlaylistIndex++;
            if (currentPlaylistIndex >= playlistVideoIds.length) {
                currentPlaylistIndex = 0;
            }
            const nextVideoId = playlistVideoIds[currentPlaylistIndex];
            loadVideoFromAPI(nextVideoId);
        }

        // Función para reproducir track anterior
        function playPreviousTrack() {
            currentPlaylistIndex--;
            if (currentPlaylistIndex < 0) {
                currentPlaylistIndex = playlistVideoIds.length - 1;
            }
            const prevVideoId = playlistVideoIds[currentPlaylistIndex];
            loadVideoFromAPI(prevVideoId);
        }

        // Función para alternar play/pause
        function togglePlayPause() {
            if (videoPlayerEl.paused) {
                videoPlayerEl.play();
            } else {
                videoPlayerEl.pause();
            }
        }

        // Cargar el primer video al inicio
        loadVideoFromAPI(playlistVideoIds[currentPlaylistIndex]);

        // Eventos para controlar reproducción
        videoPlayerEl.addEventListener('ended', playNextTrack);

        // Función de DEBUG para simular una detención completa desde la web.
        function stopPlaybackAndNotify() {
             console.log("stopPlaybackAndNotify: Deteniendo reproductor y notificando a Android...");
             if (videoPlayerEl) {
                videoPlayerEl.pause(); // Detiene el video actual
             }
             if (isAndroidApp()) {
                Android.notifyPlaybackStopped();
                 console.log("Llamado: Android.notifyPlaybackStopped()");
             }
             updateDisplayInfo("Detenido (DEBUG)");
             currentVideoInfo = { id: null, title: null, artist: null, artwork: null }; // Limpiar info
        }

        // --- Función para cargar video de YouTube ---
        async function loadYouTubeVideo() {
            const youtubeUrlInput = document.getElementById('youtube-url');
            const videoUrl = youtubeUrlInput.value.trim();

            if (!videoUrl) {
                alert('Por favor, ingresa un enlace de YouTube');
                return;
            }

            try {
                const response = await fetch(`get_youtube_audio.php?url=${encodeURIComponent(videoUrl)}`);
                const data = await response.json();
                console.log(`get_youtube_audio.php?url=${encodeURIComponent(videoUrl)}`);

                if (data.error) {
                    throw new Error(data.error);
                }

                // Extraer el ID del video de YouTube
                const videoId = extractYouTubeVideoId(videoUrl);
                
                if (videoId) {
                    // Cargar el video en el reproductor de YouTube
                    if (videoPlayerEl) {
                        videoPlayerEl.src = data.video_url;
                        videoPlayerEl.poster = data.thumbnail_url;
                        videoPlayerEl.play();
                    } else {
                        console.error('YouTube Player no está inicializado');
                    }

                    // Imprimir URLs en consola
                    console.log('Video URL:', data.video_url);
                    console.log('Thumbnail URL:', data.thumbnail_url);
                } else {
                    throw new Error('No se pudo extraer el ID del video de YouTube');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('No se pudo cargar el video. Verifica el enlace.');
            }
        }

        // Función para extraer el ID del video de YouTube
        function extractYouTubeVideoId(url) {
            // Expresiones regulares para diferentes formatos de URL de YouTube
            const patterns = [
                /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) {
                    return match[1];
                }
            }

            return null;
        }
    </script>
</body></html>